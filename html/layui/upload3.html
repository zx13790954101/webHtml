<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
		 <link rel="stylesheet" href="//apps.bdimg.com/libs/jqueryui/1.10.4/css/jquery-ui.min.css">
		<link rel="stylesheet" href="../../plugin/linzesen/linzesen.css" />
		<style type="text/css">
			.mult-img .back {
				position: absolute;
				top: 0px;
				right: 5px;
				padding: 5px;
				width: 20px;
				height: 20px;
				border-radius: 50px;
				background-color: rgba(0, 0, 0, 0.5);
				color: white;
				z-index: 99;
				cursor: pointer;
			}

			.input-file {
				overflow: hidden;
				height: 36px;
				line-height: 36px;
				display: flex;
				align-items: center;
				justify-content: center;
				min-width: 100px;
				/* box-shadow: 0px 0px 3px 2px rgba(0,0,0,0.1); */
				width: 100px;
				max-width: 100%;
				margin: 0px 10px;
				border-radius: 4px;
				position: relative;
				cursor: pointer;
				background-color: #509ef0;


			}

			.mult-img {
				margin: 15px;
			}
			.phone-box{
			
			}
			.ui-sortable{
				width: 100%;
				padding: 5px;
				list-style-type: none;
				background-color: #d9d9d9;
				height: auto;
				overflow-y: auto;
			}
.ui-sortable li{
	border: 0px;
}
			.mult-img .img-w {
				padding: 5px;
				border: 2px dotted #959595;
				margin: 5px 0px;
				overflow: hidden;
				box-sizing: border-box;
				border-radius: 5px;
				    height: 90px;
			}

			.input-file input {

				opacity: 0;
				position: absolute;
				z-index: 9;
				width: 100%;
				height: inherit;
			}

			.input-file input {}
		</style>
	</head>
	<body>

		
			<div class="lzs-item margin-20">
				<div class="input-file  margin-20">
					<input name="file" type="file" class="multiple" multiple="multiple" />
					<span class="name white">+ 上传文件</span>
				</div>

				<ul class="mult-img row flex-c">
				</ul>
				
				<h2 onclick="createDom()" class="button">上传到sm的服务器</h2>
			</div>
			
			
			<div class="analog-box row">
				
				<div class="phone-box col-lg-8">
					<ul class="phone-box-ul" id="smreturn">
						 
					</ul>	
				</div>	
				<div class="pc-box col-lg-8">
					
					
				</div>	
				
				
			</div>
				
			<a href="" class="down"></a>
			
			<div class="lzs-item margin-20">
				<div class="input-file">
					<input name="file" type="file" class="file" />
						<span class="name white">+ 上传文件</span>
				</div>
			</div>


			<div id="res"></div>
			
			<script type="text/javascript " src="../../plugin/jquery/jquery.min.js" charset="utf-8"></script>
			 <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
  <script src="../../plugin/jquery/jquery.ui.touch-punch.min.js"></script>
     <script src="https://cdn.bootcss.com/html2canvas/0.5.0-beta4/html2canvas.min.js"></script>
			<script>
				var imgarray = [];
				$(".multiple").change(function(el) {
					var f = this.files;
					var html = "";
                   
					for (var i = 0; i < this.files.length; i++) {
                        
						var formData = new FormData();
						
//  						formData.append('smfile', this.files[i]);
//  						var srcSm = uploadSm(formData);
// 						 console.log("aa",formData, this.files[i])

	                    // 新建一个FileReader
						const reader = new FileReader();
						// 读取文件 
						reader.readAsDataURL(this.files[i], "UTF-8");
						// 读取完文件之后会回来这里
						reader.onload = function(e) {
							// 读取文件内容
							const srcSm = e.target.result;
							html = '<li class="col-lg-3" onclick="delectImg(this)"><div class="img-w"><i class="back">X</i><img src=' +
								srcSm + '></div></li>';
							$(".mult-img").append(html);
							var html2 = '<li class="ui-state-default"><div class="img-w"><img src=' +srcSm + '></div></li>';
							$(".phone-box-ul").append(html2);
							var image=new Image();
							image.src=srcSm;
							
						}
					
						
						// 接下来可对文件内容进行处理
						//html='<li class="col-lg-3"><div class="img-w"><img src='+fileString+'></div></li>';
						//	$(".mult-img").append(html);
						//	}
					};
				    $( ".phone-box-ul" ).sortable();
					$( ".phone-box-ul" ).disableSelection();


				});

				function delectImg(e) {
					var index = parseInt($(e).index())
					$(e).remove();
					imgarray.splice(index, index + 1);

				}


				function upload1(){
                    					
				}
                function createDom(){
                	
					
					var cntElem  = $('#smreturn')[0];
					var shareContent = cntElem;//需要截图的包裹的（原生的）DOM 对象
				    var width = shareContent.offsetWidth; //获取dom 宽度
				    var height = shareContent.offsetHeight; //获取dom 高度
				    var canvas = document.createElement("canvas"); //创建一个canvas节点
				    var scale = 2; //定义任意放大倍数 支持小数
				    canvas.width = width * scale; //定义canvas 宽度 * 缩放
				    canvas.height = height * scale; //定义canvas高度 *缩放
				    canvas.getContext("2d").scale(scale, scale); //获取context,设置scale 
				    var opts = {
				        scale: scale, // 添加的scale 参数
				        canvas: canvas, //自定义 canvas
				        // logging: true, //日志开关，便于查看html2canvas的内部执行流程
				        width: width, //dom 原始宽度
				        height: height,
				        allowTanit:true,
						tainTest:true,
				        useCORS: true // 【重要】开启跨域配置
				    };
			
					html2canvas(shareContent,opts).then(function(canvas) {
							 
							 	var codeimg=canvas.toDataURL()
	
								// 		var URL = URL || webkitURL;
								// 		var blob = URL.createObjectURL(codeimg);

							    // 构造新File对象
							
// 						     	var image2= new Image();
// 		                        image2.src=canvas.toDataURL();
// 								var aafile = new File([codeimg], "test1.png",{type:"image/png"});
// 								console.log("data",aafile,codeimg)
                                var aafile=dataURLtoFile(codeimg,"test.png")
								var formData = new FormData();				
								formData.append('smfile', aafile);
						
								var  smdata=uploadSm(formData);
								
							
						document.body.appendChild(canvas);
						//canvas转换成url，然后利用a标签的download属性，直接下载，绕过上传服务器再下载
						document.querySelector(".down").setAttribute('href', canvas.toDataURL());
					
					});
				}
					//转换为照片
				function dataURLtoFile(dataurl, filename) {
					var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
						bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
					while(n--){
						u8arr[n] = bstr.charCodeAt(n);
					}
					return new File([u8arr], filename, {type:mime});
				}
				//上传到sm的地址
				function uploadSm(formData, callback) {
					var backData = '';
					$.ajax({
						url: 'https://sm.ms/api/upload',
						type: 'POST',
						async: false, //使用同步的方式,true为异步方式
						success: function(data) {
							//$('#res').html(JSON.stringify(data.data.url));


							backData = data.data.url;
							backData.replace(/\"/g, "");
							imgarray.push(backData)

							//   return JSON.stringify(data.data.url);

						},
						error: function(data) {
							console.log(data);
						},
						data: formData,
						cache: false,
						contentType: false,
						processData: false

					});
					return backData;
				}

				$('.file').change(function() {
					var f = this.files[0];
					var formData = new FormData();
					formData.append('smfile', f);

					$.ajax({
						url: 'https://sm.ms/api/upload',
						type: 'POST',
						success: function(data) {
							console.log(data);
							$('#res').html(JSON.stringify(data.data.url));
							console.log(data);
						},
						error: function(data) {
							console.log(data);
						},

						data: formData,
						cache: false,
						contentType: false,
						processData: false

					});
				});
			</script>
	</body>
</html>
